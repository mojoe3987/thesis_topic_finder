<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thesis Topic Development Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const ThesisTopicFinder = () => {
            const [currentStage, setCurrentStage] = useState(0);
            const [stageData, setStageData] = useState({});
            const [conversation, setConversation] = useState([]);
            const [userInput, setUserInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showExport, setShowExport] = useState(false);
            const chatContainerRef = React.useRef(null);
            const [isEvaluating, setIsEvaluating] = useState(false);
            const [evaluation, setEvaluation] = useState(null);
            const [liveSummaries, setLiveSummaries] = useState({});
            const [editableSummaries, setEditableSummaries] = useState({});
            const [showIntro, setShowIntro] = useState(true);
            const inputRef = React.useRef(null);
            const [hasTyped, setHasTyped] = useState(false);

            // Auto-scroll function
            const scrollToBottom = () => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            };

            const scrollToTopOfPage = () => {
                try {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } catch (_) {
                    window.scrollTo(0, 0);
                }
            };

            // Generate live summary for current stage
            const generateLiveSummary = async (stageId, userMessages) => {
                if (!userMessages || userMessages.length === 0) return;

                const stage = stages.find(s => s.id === stageId);
                if (!stage) return;

                let summaryPrompt = '';
                if (stageId === 'topic') {
                    summaryPrompt = `Summarize the student's research interest into a clear topic statement.

Student's responses: ${userMessages.join('\n\n')}

Rules:
- ONLY use words and concepts the student actually mentioned
- Do NOT add new concepts, theories, or details they didn't mention
- Do NOT ask questions or add question marks
- Simply combine and organize their words into 1-2 sentences
- If they say "I like luxury marketing and brands" ‚Üí return "luxury marketing and brands"

Return ONLY a topic statement, no questions.`;
                } else if (stageId === 'problem') {
                    summaryPrompt = `Summarize the student's research problem into a clear statement.

Student's responses: ${userMessages.join('\n\n')}

Rules:
- ONLY use words and concepts the student actually mentioned
- Do NOT add new concepts, theories, or details they didn't mention
- Do NOT ask questions or add question marks
- If they mentioned problems/challenges, combine their words into 1-2 sentences
- If they haven't mentioned problems yet, just restate their topic area
- Simply combine and organize their words

Return ONLY a problem statement, no questions.`;
                } else if (stageId === 'purpose') {
                    summaryPrompt = `Summarize the student's research purpose into a clear purpose statement.

Student's responses: ${userMessages.join('\n\n')}

Rules:
- ONLY use words and concepts the student actually mentioned
- Do NOT add new concepts, theories, or details they didn't mention
- Do NOT ask questions or add question marks
- Combine their words into 1-2 sentences describing what they aim to achieve

Return ONLY a purpose statement, no questions.`;
                } else if (stageId === 'question') {
                    summaryPrompt = `Summarize the student's intended research question in one clear, answerable question.

Student's responses: ${userMessages.join('\n\n')}

Rules:
- ONLY use words and concepts the student actually mentioned
- Do NOT add new concepts, theories, or details they didn't mention
- Phrase as a single research question, without introducing new variables or populations
- If insufficient information, use the closest possible formulation using provided words

Return ONLY the research question, no extra text.`;
                }

                try {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'API_KEY_HERE',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'anthropic/claude-3.5-sonnet',
                            max_tokens: 200,
                            temperature: 0,
                            messages: [
                                { role: 'user', content: summaryPrompt }
                            ]
                        })
                    });

                    const data = await response.json();
                    const summary = data?.choices?.[0]?.message?.content?.trim() || '';
                    
                    if (summary) {
                        setLiveSummaries(prev => ({
                            ...prev,
                            [stageId]: summary
                        }));
                        setEditableSummaries(prev => ({
                            ...prev,
                            [stageId]: summary
                        }));
                    }
                } catch (error) {
                    console.error('Error generating summary:', error);
                }
            };

            const stages = [
                {
                    id: 'topic',
                    title: 'Stage 1: Define Your Topic',
                    description: 'Start broad, then narrow down to a specific area of interest',
                    color: 'blue',
                    prompt: `You are helping a master's student narrow down from a general topic to a specific research area. Your role is to ask GUIDING QUESTIONS.

Guidelines (very important):
- Use simple, conversational language for non-experts.
- Do NOT mention methods, statistics, models, or technical terms.
- Ask at most 1‚Äì2 short questions (one sentence each). No lists, no jargon.

Current stage: Topic Definition

Ask 1-2 focused questions that help them:
- Move from general interest to specific focus area
- Identify what aspect of their field they want to explore

Be encouraging and help them get more specific. DO NOT suggest topics. Only ask questions.`
                },
                {
                    id: 'problem',
                    title: 'Stage 2: Identify the Research Problem',
                    description: 'THIS IS CRUCIAL! What is the problem? Who cares?',
                    color: 'red',
                    prompt: `You are helping a master's student identify the RESEARCH PROBLEM - this is the most critical step! Your role is to ask CHALLENGING QUESTIONS.

Guidelines (very important):
- Use simple, encouraging language. Avoid jargon.
- Do NOT suggest methods, statistics, or study designs.
- Ask at most 1‚Äì2 short questions (one sentence each). Keep it concrete.

Current stage: Research Problem Identification

Student's topic: {topic}

Ask 1-2 sharp questions that help them:
- Identify what specific problem exists in their area
- Articulate WHY this problem matters (the "so what?" question)

Be direct and challenging. This is the make-or-break step. Help them find a genuine problem that matters.`
                },
                {
                    id: 'purpose',
                    title: 'Stage 3: Craft Your Purpose Statement',
                    description: 'What do you want to achieve with your research?',
                    color: 'green',
                    prompt: `You are helping a master's student formulate a clear purpose statement. Your role is to ask FOCUSING QUESTIONS about their research goals.

Guidelines (very important):
- Use simple language suitable for beginners.
- Do NOT introduce methods, statistics, or technical frameworks.
- Ask at most 1‚Äì2 short questions (one sentence each).

Current stage: Purpose Statement

Student's journey so far:
Topic: {topic}
Research Problem: {problem}

Ask 1-2 questions that help them:
- Articulate what they want to discover or understand through their research
- Define what specific knowledge or insights they aim to contribute

Focus on their research objectives and learning goals, not just restating the problem. Help them think about what they want to achieve. DO NOT write their purpose for them.`
                },
                {
                    id: 'question',
                    title: 'Stage 4: Formulate Your Research Question',
                    description: 'Can you state your research question precisely?',
                    color: 'purple',
                    prompt: `You are helping a master's student formulate a precise research question. Your role is to help them SHARPEN their thinking.

Guidelines (very important):
- Use plain language; avoid technical terms unless the student already used them.
- Do NOT discuss study designs, variables, or stats unless explicitly mentioned by the student.
- Ask at most 1‚Äì2 short questions (one sentence each).

Current stage: Research Question Formulation

Student's journey so far:
Topic: {topic}
Research Problem: {problem}
Purpose: {purpose}

Ask 1-2 questions that help them:
- Turn their purpose into a specific, answerable question
- Ensure the question directly addresses their identified problem

Help them craft precision. DO NOT write their question for them.`
                },
                {
                    id: 'feasibility',
                    title: 'Stage 5: Reality Check',
                    description: 'Can you actually do this research?',
                    color: 'yellow',
                    prompt: `You are helping a master's student reality-test their research question. Your role is to ask PRACTICAL QUESTIONS.

Guidelines (very important):
- Keep language simple and practical (time, access, resources). Avoid technical jargon.
- Do NOT require naming methods or statistics; just ask in everyday terms.
- Ask at most 1‚Äì2 short questions (one sentence each).

Current stage: Feasibility Check

Their research question: {question}

Ask 1-2 tough questions about:
- Data access: Can they get the information they need?
- Time constraints: Can this be done in their timeframe?

Be realistic but not discouraging. Help them spot problems now, not later.`
                }
            ];

            const startConversation = async () => {
                const stage = stages[currentStage];
                let systemPrompt = stage.prompt;
                
                // Replace placeholders with actual data
                Object.keys(stageData).forEach(key => {
                    systemPrompt = systemPrompt.replace(`{${key}}`, stageData[key] || '[Not yet provided]');
                });

                const initialMessage = `Welcome to ${stage.title}!\n\n${stage.description}\n\nLet me ask you some questions to help you reflect...`;
                
                setConversation([{ role: 'assistant', content: initialMessage }]);
                setIsLoading(true);

                try {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'API_KEY_HERE',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'anthropic/claude-3.5-sonnet',
                            max_tokens: 1000,
                            messages: [
                                {
                                    role: 'system',
                                    content: systemPrompt
                                },
                                {
                                    role: 'user',
                                    content: 'Generate your first set of reflective questions for the student.'
                                }
                            ]
                        })
                    });

                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;

                    setConversation(prev => [...prev, { role: 'assistant', content: aiResponse }]);
                } catch (error) {
                    setConversation(prev => [...prev, { 
                        role: 'assistant', 
                        content: 'I apologize, but I encountered an error. Please try refreshing the page.' 
                    }]);
                }
                
                setIsLoading(false);
                // Auto-scroll after AI response
                setTimeout(scrollToBottom, 100);
            };

            const handleSendMessage = async () => {
                if (!userInput.trim() || isLoading) return;

                const newMessage = { role: 'user', content: userInput };
                setConversation(prev => [...prev, newMessage]);
                setUserInput('');
                setIsLoading(true);
                // Auto-scroll after user message
                setTimeout(scrollToBottom, 100);

                try {
                    const stage = stages[currentStage];
                    let systemPrompt = stage.prompt;
                    
                    // If the student has already had ~3 turns in Stage 1, stop asking new questions and offer to finalize the topic
                    const userTurns = conversation.filter(m => m.role === 'user').length + 1;
                    if (stage.id === 'topic' && userTurns >= 3) {
                        systemPrompt += '\n\nYou have already asked enough guiding questions. Do NOT ask new questions. Summarize the student\'s topic in 1-2 lines, ask for quick confirmation to lock it, and suggest proceeding to the next stage.';
                    }
                    
                    Object.keys(stageData).forEach(key => {
                        systemPrompt = systemPrompt.replace(`{${key}}`, stageData[key] || '[Not yet provided]');
                    });

                    const messages = conversation
                        .filter(msg => msg.role !== 'assistant' || !msg.content.includes('Welcome to'))
                        .concat([newMessage]);

                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'API_KEY_HERE',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'anthropic/claude-3.5-sonnet',
                            max_tokens: 1000,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                ...messages.slice(-6)
                            ]
                        })
                    });

                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;

                    setConversation(prev => [...prev, { role: 'assistant', content: aiResponse }]);
                } catch (error) {
                    setConversation(prev => [...prev, { 
                        role: 'assistant', 
                        content: 'I apologize, but I encountered an error. Please try again.' 
                    }]);
                }

                setIsLoading(false);
                // Auto-scroll after AI response
                setTimeout(scrollToBottom, 100);
                
                // Generate live summary for topic and problem stages
                const userMessages = conversation
                    .filter(m => m.role === 'user')
                    .map(m => m.content)
                    .concat([userInput]);
                
                if (stage.id === 'topic' || stage.id === 'problem' || stage.id === 'purpose' || stage.id === 'question') {
                    generateLiveSummary(stage.id, userMessages);
                }
            };

            // Evaluate the current research question against a rubric
            const evaluateResearchQuestion = async () => {
                // Determine the question text: prefer the latest user message in the current stage; fallback to accumulated stageData.question
                const latestUserMsg = [...conversation].reverse().find(m => m.role === 'user');
                const questionText = (latestUserMsg && latestUserMsg.content) || stageData.question || '';
                if (!questionText || isEvaluating) return;

                setIsEvaluating(true);
                setEvaluation(null);

                const rubric = `You are an expert research methods mentor. Evaluate the student's research question using the following rubric. Return ONLY valid JSON matching the schema below. Do NOT propose any rewritten question.

Rubric dimensions (0-5 each, integers):
- clear: easy to understand, not vague
- focused: specific and not too broad
- concise: brief and to the point
- complex: warrants analysis; beyond yes/no
- arguable: open to debate; requires evidence
- significance: relevance/so-what
- novelty: degree of originality vs known literature
- curiosity: reflects genuine intellectual interest
- actionability: can be investigated with available methods/data
- scope: feasible in master's thesis constraints

JSON schema:
{
  "scores": {
    "clear": 0, "focused": 0, "concise": 0, "complex": 0, "arguable": 0,
    "significance": 0, "novelty": 0, "curiosity": 0, "actionability": 0, "scope": 0
  },
  "strengths": ["..."],
  "risks": ["..."],
  "recommendations": ["..."]
}

Evaluate the question and provide recommendations only; do NOT propose or include a revised question.`;

                try {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'API_KEY_HERE',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'anthropic/claude-3.5-sonnet',
                            max_tokens: 800,
                            messages: [
                                { role: 'system', content: rubric },
                                { role: 'user', content: `Student's research question: "${questionText}"` }
                            ]
                        })
                    });

                    const data = await response.json();
                    const content = data?.choices?.[0]?.message?.content || '{}';
                    let parsed = null;
                    try { parsed = JSON.parse(content); } catch (e) { parsed = null; }
                    if (!parsed || !parsed.scores) {
                        // Attempt to salvage JSON from any text
                        const match = content.match(/\{[\s\S]*\}$/);
                        if (match) {
                            try { parsed = JSON.parse(match[0]); } catch (_) {}
                        }
                    }
                    if (parsed) {
                        setEvaluation(parsed);
                    } else {
                        setEvaluation({ error: 'Could not parse evaluation.' });
                    }
                } catch (err) {
                    setEvaluation({ error: 'Evaluation failed. Please try again.' });
                }

                setIsEvaluating(false);
                setTimeout(scrollToBottom, 100);
            };

            const handleNextStage = () => {
                const stage = stages[currentStage];
                const summary = conversation
                    .filter(msg => msg.role === 'user')
                    .map(msg => msg.content)
                    .join('\n\n');
                
                setStageData(prev => ({
                    ...prev,
                    [stage.id]: summary
                }));

                if (currentStage < stages.length - 1) {
                    setCurrentStage(currentStage + 1);
                    setConversation([]);
                    scrollToTopOfPage();
                } else {
                    setShowExport(true);
                }
            };

            const handlePrevStage = () => {
                if (currentStage === 0) return;
                setCurrentStage(currentStage - 1);
                setConversation([]);
                scrollToTopOfPage();
            };

            // Lock current stage's content based on editable summary and move to next stage
            const lockAndNext = () => {
                const stage = stages[currentStage];
                // Use editable summary if available, otherwise fall back to AI summary or raw conversation
                const summary = editableSummaries[stage.id] || liveSummaries[stage.id] || conversation
                    .filter(msg => msg.role === 'user')
                    .map(msg => msg.content)
                    .join('\n\n');
                setStageData(prev => ({
                    ...prev,
                    [stage.id]: summary || prev[stage.id] || '[Not yet provided]'
                }));
                if (currentStage < stages.length - 1) {
                    setCurrentStage(currentStage + 1);
                    setConversation([]);
                    scrollToTopOfPage();
                } else {
                    setShowExport(true);
                }
            };

            const handleExport = () => {
                const worksheet = `THESIS TOPIC DEVELOPMENT WORKSHEET
Generated: ${new Date().toLocaleDateString()}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STAGE 1: YOUR RESEARCH TOPIC
${stageData.topic || 'Not completed'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STAGE 2: RESEARCH PROBLEM (CRUCIAL!)
${stageData.problem || 'Not completed'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STAGE 3: PURPOSE STATEMENT
${stageData.purpose || 'Not completed'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STAGE 4: RESEARCH QUESTION
${stageData.question || 'Not completed'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STAGE 5: FEASIBILITY CONSIDERATIONS
${stageData.feasibility || 'Not completed'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

RESEARCH QUESTION EVALUATION
${evaluation ? `
Scores (out of 5):
‚Ä¢ Clear: ${evaluation.scores?.clear || 'N/A'}/5
‚Ä¢ Focused: ${evaluation.scores?.focused || 'N/A'}/5
‚Ä¢ Concise: ${evaluation.scores?.concise || 'N/A'}/5
‚Ä¢ Complex: ${evaluation.scores?.complex || 'N/A'}/5
‚Ä¢ Arguable: ${evaluation.scores?.arguable || 'N/A'}/5
‚Ä¢ Significance: ${evaluation.scores?.significance || 'N/A'}/5
‚Ä¢ Novelty: ${evaluation.scores?.novelty || 'N/A'}/5
‚Ä¢ Curiosity: ${evaluation.scores?.curiosity || 'N/A'}/5
‚Ä¢ Actionability: ${evaluation.scores?.actionability || 'N/A'}/5
‚Ä¢ Scope: ${evaluation.scores?.scope || 'N/A'}/5

Strengths:
${evaluation.strengths?.map(s => `‚Ä¢ ${s}`).join('\n') || 'None identified'}

Areas for Improvement:
${evaluation.risks?.map(r => `‚Ä¢ ${r}`).join('\n') || 'None identified'}

Recommendations:
${evaluation.recommendations?.map(r => `‚Ä¢ ${r}`).join('\n') || 'None provided'}
` : 'No evaluation completed'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

                const blob = new Blob([worksheet], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'thesis-topic-worksheet.txt';
                a.click();
                URL.revokeObjectURL(url);
            };

            useEffect(() => {
                if (showIntro) return;
                if (conversation.length === 0 && !showExport) {
                    startConversation();
                }
            }, [currentStage, showIntro]);

            // Focus input and nudge on stage change
            useEffect(() => {
                if (inputRef.current) {
                    try { inputRef.current.focus({ preventScroll: true }); } catch (_) {}
                    inputRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                setHasTyped(false);
            }, [currentStage]);

            // Auto-scroll when conversation changes
            useEffect(() => {
                scrollToBottom();
            }, [conversation]);

            const getColorClasses = (color) => {
                const colors = {
                    blue: 'bg-blue-100 text-blue-800 border-blue-300',
                    green: 'bg-green-100 text-green-800 border-green-300',
                    yellow: 'bg-yellow-100 text-yellow-800 border-yellow-300',
                    purple: 'bg-purple-100 text-purple-800 border-purple-300',
                    red: 'bg-red-100 text-red-800 border-red-300'
                };
                return colors[color] || colors.blue;
            };

            const getStageLabel = (id) => {
                switch (id) {
                    case 'topic': return 'research topic';
                    case 'problem': return 'research problem';
                    case 'purpose': return 'purpose statement';
                    case 'question': return 'research question';
                    case 'feasibility': return 'feasibility';
                    default: return 'stage';
                }
            };

            const getNextStageLabel = (id) => {
                switch (id) {
                    case 'topic': return 'research problem';
                    case 'problem': return 'purpose statement';
                    case 'purpose': return 'research question';
                    case 'question': return 'feasibility check';
                    default: return 'next stage';
                }
            };

            const stageBg = {
                topic: 'from-blue-50 to-blue-100',
                problem: 'from-red-50 to-red-100',
                purpose: 'from-green-50 to-green-100',
                question: 'from-purple-50 to-purple-100',
                feasibility: 'from-yellow-50 to-yellow-100'
            };

            if (showIntro) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-50 p-8">
                        <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8">
                            <h1 className="text-3xl font-bold text-gray-800 mb-4">Master's Thesis Topic & Research Question Tool</h1>
                            <p className="text-gray-700 mb-4">
                                This tool helps you develop a master's thesis: define your research topic, identify the research problem,
                                craft your purpose statement, formulate your research question, and check feasibility.
                            </p>
                            <ul className="list-disc ml-6 text-gray-700 space-y-2 mb-6">
                                <li>Answer 1‚Äì2 simple questions per stage.</li>
                                <li>Review the AI summary in the editable box.</li>
                                <li><span className="font-semibold">Lock</span> the summary to move to the next stage.</li>
                            </ul>
                            <div className="bg-blue-50 border border-blue-200 rounded p-4 mb-6">
                                <div className="font-semibold text-blue-800 mb-1">Progress rule</div>
                                <div className="text-blue-800">
                                    You must lock your Topic, Problem, Purpose, and Question to progress through the stages.
                                </div>
                            </div>
                            <button
                                onClick={() => setShowIntro(false)}
                                className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700"
                            >
                                Get started ‚Üí
                            </button>
                        </div>
                    </div>
                );
            }

            if (showExport) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-50 p-8">
                        <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üéâ</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-4">
                                    Congratulations!
                                </h1>
                                <p className="text-gray-600 text-lg">
                                    You've completed the thesis topic development process.
                                </p>
                            </div>

                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                                <h2 className="text-xl font-semibold text-blue-800 mb-3">
                                    Next Steps:
                                </h2>
                                <ol className="list-decimal list-inside space-y-2 text-blue-700">
                                    <li>Download your worksheet below</li>
                                    <li>Schedule a meeting with your thesis advisor</li>
                                    <li>Refine your question based on their feedback</li>
                                    <li>Begin your formal research proposal</li>
                                </ol>
                            </div>

                            <div className="flex gap-4">
                                <button
                                    onClick={handleExport}
                                    className="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
                                >
                                    üì• Download Worksheet
                                </button>
                                <button
                                    onClick={() => {
                                        setShowExport(false);
                                        setCurrentStage(0);
                                        setStageData({});
                                        setConversation([]);
                                    }}
                                    className="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                                >
                                    üîÑ Start Over
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const stage = stages[currentStage];
            const hasUserTurn = conversation.some(m => m.role === 'user');

            return (
                <div className={`min-h-screen bg-gradient-to-br ${stageBg[stage.id] || 'from-indigo-50 to-blue-50'} p-4`}>
                    <div className="max-w-5xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">Master's Thesis Topic & Research Question Tool</h1>
                            <p className="text-gray-600 mb-4">Guided steps to define your topic, problem, purpose, question, and feasibility</p>
                            
                            {/* Progress Stepper */}
                            <div className="flex items-center gap-3 mb-4">
                                {[
                                    { id:'topic', label:'Topic' },
                                    { id:'problem', label:'Problem' },
                                    { id:'purpose', label:'Purpose' },
                                    { id:'question', label:'Question' },
                                    { id:'feasibility', label:'Feasibility' },
                                ].map((s, idx) => {
                                    const isActive = s.id === stage.id;
                                    const isLocked = !!stageData[s.id];
                                    return (
                                        <div key={s.id} className="flex-1">
                                            <div className={`h-2 rounded-full ${idx <= stages.findIndex(x=>x.id===stage.id) ? 'bg-indigo-600' : 'bg-gray-200'}`}></div>
                                            <div className="flex items-center justify-between mt-1">
                                                <div className={`text-xs ${isActive ? 'text-indigo-700 font-semibold' : 'text-gray-600'}`}>{s.label}</div>
                                                {isLocked && <span className="text-xs text-green-700">‚úì</span>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            {/* Current Stage Badge */}
                            <div className={`inline-block px-4 py-2 rounded-lg border ${getColorClasses(stage.color)} ${stage.id === 'problem' ? 'ring-2 ring-red-400 ring-opacity-50' : ''}`}>
                                <div className="font-semibold">{stage.title}</div>
                                <div className="text-sm mt-1">{stage.description}</div>
                                {stage.id === 'problem' && (
                                    <div className="text-xs mt-1 font-bold text-red-600">
                                        ‚ö†Ô∏è This is the most critical step!
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Conversation Area with Side-by-Side Layout */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            {/* Chat Box - Left Side */}
                            <div className="bg-white rounded-2xl shadow-2xl p-0 border-2 border-indigo-300 ring-2 ring-indigo-200/50 overflow-hidden" style={{ minHeight: '420px' }}>
                                <div className="px-6 py-4 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white flex items-center justify-between">
                                    <div className="text-lg font-semibold">Chat with your AI Mentor</div>
                                    <div className="text-xs opacity-90">This is the main area ‚Äî start here</div>
                                </div>
                                <div className="p-6">
                                    <div ref={chatContainerRef} className="space-y-4 mb-4" style={{ maxHeight: '500px', overflowY: 'auto' }}>
                                {conversation.map((msg, idx) => (
                                    <div
                                        key={idx}
                                        className={`p-4 rounded-lg ${
                                            msg.role === 'assistant'
                                                ? 'bg-indigo-50 border border-indigo-200'
                                                : 'bg-gray-50 border border-gray-200 ml-8'
                                        }`}
                                    >
                                        <div className="font-semibold text-sm mb-2 text-gray-600">
                                            {msg.role === 'assistant' ? 'ü§ñ AI Mentor' : 'üë§ You'}
                                        </div>
                                        <div className="whitespace-pre-wrap">{msg.content}</div>
                                    </div>
                                ))}
                                {isLoading && (
                                    <div className="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                                        <div className="flex items-center gap-2">
                                            <div className="animate-spin h-4 w-4 border-2 border-indigo-600 border-t-transparent rounded-full"></div>
                                            <span className="text-indigo-600">Thinking...</span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Input Area */}
                            <div className="border-t pt-4">
                                <div className="mb-2 flex items-center gap-2 text-indigo-700">
                                    <span className="text-sm font-semibold">Start here:</span>
                                    <span className="text-sm">Type your thoughts and press Enter</span>
                                    <span className="ml-auto text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded">Focus is here</span>
                                </div>
                                <textarea
                                    ref={inputRef}
                                    value={userInput}
                                    onChange={(e) => { if (!hasTyped && e.target.value.trim().length > 0) setHasTyped(true); setUserInput(e.target.value); }}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            handleSendMessage();
                                        }
                                    }}
                                    placeholder="Type your thoughts here... (Press Enter to send, Shift+Enter for new line)"
                                    className={`w-full p-4 text-base border-2 rounded-xl resize-none transition-all ${hasTyped ? 'border-indigo-300 focus:ring-2 focus:ring-indigo-500' : 'border-indigo-400 ring-2 ring-indigo-300 animate-pulse'} focus:border-indigo-500 bg-white shadow`}
                                    rows="4"
                                    disabled={isLoading}
                                />
                                <div className="flex gap-3 mt-3">
                                    <button
                                        onClick={handleSendMessage}
                                        disabled={isLoading || !userInput.trim()}
                                        className="flex-1 bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    >
                                        Send Response
                                    </button>

                                    {/* Back button */}
                                    {currentStage > 0 && (
                                    <button
                                            onClick={handlePrevStage}
                                            className="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                                    >
                                            ‚Üê Back
                                    </button>
                                    )}

                                </div>
                                <p className="text-sm text-gray-500 mt-2">
                                            üí° Tip: Start with at least one exchange before locking your {stage.id === 'topic' ? 'topic' : stage.id === 'problem' ? 'problem' : 'response'}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Box - Right Side - Always visible */}
                            <div className="bg-white rounded-2xl shadow-lg p-6 border-2 border-gray-200" style={{ minHeight: '420px' }}>
                                <div className="text-lg font-semibold text-gray-800 mb-4">Your Research Summary</div>
                                
                                <div className="space-y-4">
                                    {/* Topic - show if locked */}
                                    {stageData.topic && (
                                        <div className="p-3 rounded-lg bg-blue-50 border border-blue-200">
                                            <div className="text-xs font-semibold text-blue-800 mb-1">Topic (Locked)</div>
                                            <div className="text-sm text-blue-900 whitespace-pre-wrap">{stageData.topic}</div>
                                        </div>
                                    )}

                                    {/* Research Problem */}
                                    {stageData.problem ? (
                                        <div className="p-3 rounded-lg bg-red-50 border border-red-200">
                                            <div className="text-xs font-semibold text-red-800 mb-1">Research Problem (Locked)</div>
                                            <div className="text-sm text-red-900 whitespace-pre-wrap">{stageData.problem}</div>
                                        </div>
                                    ) : stage.id === 'problem' && (
                                        <div>
                                            <div className="text-sm font-semibold text-gray-700 mb-2">Research Problem</div>
                                            {!stageData.problem && hasUserTurn && (
                                                <div className="p-3 rounded-lg bg-amber-50 border border-amber-300 text-amber-900 text-sm mb-3">
                                                    {`To continue to the development of the ${getNextStageLabel(stage.id)}, accept or edit the AI summary below and click "Lock ${getStageLabel(stage.id)} and go to next stage".`}
                                                </div>
                                            )}
                                            {editableSummaries.problem ? (
                                                <div>
                                                    <textarea
                                                        value={editableSummaries.problem || ''}
                                                        onChange={(e) => setEditableSummaries(prev => ({ ...prev, problem: e.target.value }))}
                                                        className="w-full p-4 border-2 border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                                                        rows="6"
                                                        placeholder="Enter your research problem here..."
                                                    />
                                                    <div className="text-xs text-gray-500 mt-2">
                                                        üí° You can edit this summary before locking it.
                                                    </div>
                                                    <button
                                                        onClick={lockAndNext}
                                                        disabled={conversation.filter(m => m.role === 'user').length < 1}
                                                        className="mt-3 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                                    >
                                                        Lock problem and go to next stage
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="text-sm text-gray-400 italic">AI summary will appear here after you start chatting</div>
                                            )}
                                        </div>
                                    )}

                                    {/* Purpose Statement */}
                                    {stageData.purpose ? (
                                        <div className="p-3 rounded-lg bg-green-50 border border-green-200">
                                            <div className="text-xs font-semibold text-green-800 mb-1">Purpose (Locked)</div>
                                            <div className="text-sm text-green-900 whitespace-pre-wrap">{stageData.purpose}</div>
                                        </div>
                                    ) : stage.id === 'purpose' && (
                                        <div>
                                            <div className="text-sm font-semibold text-gray-700 mb-2">Purpose Statement</div>
                                            {!stageData.purpose && hasUserTurn && (
                                                <div className="p-3 rounded-lg bg-amber-50 border border-amber-300 text-amber-900 text-sm mb-3">
                                                    {`To continue to the development of the ${getNextStageLabel(stage.id)}, accept or edit the AI summary below and click "Lock ${getStageLabel(stage.id)} and go to next stage".`}
                                                </div>
                                            )}
                                            {editableSummaries.purpose ? (
                                                <div>
                                                    <textarea
                                                        value={editableSummaries.purpose || ''}
                                                        onChange={(e) => setEditableSummaries(prev => ({ ...prev, purpose: e.target.value }))}
                                                        className="w-full p-4 border-2 border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                                                        rows="6"
                                                        placeholder="Enter your purpose statement here..."
                                                    />
                                                    <div className="text-xs text-gray-500 mt-2">
                                                        üí° You can edit this summary before locking it.
                                                    </div>
                                                    <button
                                                        onClick={lockAndNext}
                                                        disabled={conversation.filter(m => m.role === 'user').length < 1}
                                                        className="mt-3 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                                    >
                                                        Lock purpose and go to next stage
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="text-sm text-gray-400 italic">AI summary will appear here after you start chatting</div>
                                            )}
                                        </div>
                                    )}

                                    {/* Research Question */}
                                    {stageData.question ? (
                                        <div className="p-3 rounded-lg bg-purple-50 border border-purple-200">
                                            <div className="text-xs font-semibold text-purple-800 mb-1">Research Question (Locked)</div>
                                            <div className="text-sm text-purple-900 whitespace-pre-wrap">{stageData.question}</div>
                                        </div>
                                    ) : stage.id === 'question' && (
                                        <div>
                                            <div className="text-sm font-semibold text-gray-700 mb-2">Research Question</div>
                                            {!stageData.question && hasUserTurn && (
                                                <div className="p-3 rounded-lg bg-amber-50 border border-amber-300 text-amber-900 text-sm mb-3">
                                                    {`To continue to the development of the ${getNextStageLabel(stage.id)}, accept or edit the AI summary below and click "Lock ${getStageLabel(stage.id)} and go to next stage".`}
                                                </div>
                                            )}
                                            {editableSummaries.question ? (
                                                <div>
                                                    <textarea
                                                        value={editableSummaries.question || ''}
                                                        onChange={(e) => setEditableSummaries(prev => ({ ...prev, question: e.target.value }))}
                                                        className="w-full p-4 border-2 border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                                                        rows="6"
                                                        placeholder="Enter your research question here..."
                                                    />
                                                    <div className="text-xs text-gray-500 mt-2">
                                                        üí° You can edit this summary before locking it.
                                                    </div>
                                                    <div className="flex gap-3 mt-3">
                                                        <button
                                                            onClick={evaluateResearchQuestion}
                                                            disabled={isEvaluating}
                                                            className="bg-amber-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-amber-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                                        >
                                                            {isEvaluating ? 'Evaluating‚Ä¶' : 'Evaluate Question'}
                                                        </button>
                                                        <button
                                                            onClick={lockAndNext}
                                                            disabled={conversation.filter(m => m.role === 'user').length < 1}
                                                            className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                                        >
                                                            Lock question and go to next stage
                                                        </button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="text-sm text-gray-400 italic">AI summary will appear here after you start chatting</div>
                                            )}
                                        </div>
                                    )}

                                    {/* Topic - current stage (only if not locked and on topic stage) */}
                                    {!stageData.topic && stage.id === 'topic' && (
                                        <div>
                                            <div className="text-sm font-semibold text-gray-700 mb-2">Research Topic</div>
                                            {hasUserTurn && (
                                                <div className="p-3 rounded-lg bg-amber-50 border border-amber-300 text-amber-900 text-sm mb-3">
                                                    {`To continue to the development of the ${getNextStageLabel(stage.id)}, accept or edit the AI summary below and click "Lock ${getStageLabel(stage.id)} and go to next stage".`}
                                                </div>
                                            )}
                                            {editableSummaries.topic ? (
                                                <div>
                                                    <textarea
                                                        value={editableSummaries.topic || ''}
                                                        onChange={(e) => setEditableSummaries(prev => ({ ...prev, topic: e.target.value }))}
                                                        className="w-full p-4 border-2 border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                                                        rows="6"
                                                        placeholder="Enter your research topic here..."
                                                    />
                                                    <div className="text-xs text-gray-500 mt-2">
                                                        üí° You can edit this summary before locking it.
                                                    </div>
                                                    <button
                                                        onClick={lockAndNext}
                                                        disabled={conversation.filter(m => m.role === 'user').length < 1}
                                                        className="mt-3 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                                    >
                                                        Lock topic and go to next stage
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="text-sm text-gray-400 italic">AI summary will appear here after you start chatting</div>
                                            )}
                                        </div>
                                    )}

                                    {stage.id === 'question' && evaluation && (
                                        <div className="mt-6 p-4 border rounded-lg bg-gray-50">
                                            {evaluation.error ? (
                                                <div className="text-red-600 font-semibold">{evaluation.error}</div>
                                            ) : (
                                                <div className="space-y-3">
                                                    <div className="font-semibold text-gray-800">Research Question Evaluation</div>
                                                    <div className="grid grid-cols-1 gap-3">
                                                        {Object.entries(evaluation.scores || {}).map(([k,v]) => (
                                                            <div key={k} className="text-sm">
                                                                <div className="flex justify-between"><span className="capitalize">{k}</span><span className="font-mono">{v}/5</span></div>
                                                                <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                                                    <div className={`${v >= 4 ? 'bg-green-500' : v >= 2 ? 'bg-amber-500' : 'bg-red-500'}`} style={{ width: `${Math.min(5, v || 0) * 20}%`, height: '100%' }}></div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    {evaluation.strengths?.length > 0 && (
                                                        <div>
                                                            <div className="font-medium">Strengths</div>
                                                            <ul className="list-disc ml-5 text-sm text-gray-700 space-y-1">
                                                                {evaluation.strengths.map((s, i) => <li key={i}>{s}</li>)}
                                                            </ul>
                                                        </div>
                                                    )}
                                                    {evaluation.risks?.length > 0 && (
                                                        <div>
                                                            <div className="font-medium">Risks / Weaknesses</div>
                                                            <ul className="list-disc ml-5 text-sm text-gray-700 space-y-1">
                                                                {evaluation.risks.map((s, i) => <li key={i}>{s}</li>)}
                                                            </ul>
                                                        </div>
                                                    )}
                                                    {evaluation.recommendations?.length > 0 && (
                                                        <div>
                                                            <div className="font-medium">Recommendations</div>
                                                            <ul className="list-disc ml-5 text-sm text-gray-700 space-y-1">
                                                                {evaluation.recommendations.map((s, i) => <li key={i}>{s}</li>)}
                                                            </ul>
                                                        </div>
                                                    )}
                                                    <div className="mt-4 pt-4 border-t">
                                                        <div className="font-semibold text-gray-800 mb-2">Evaluation criteria</div>
                                                        <div className="grid grid-cols-1 gap-2 text-gray-700 text-xs">
                                                            <div><strong>Clear:</strong> Easy to understand, not vague or ambiguous</div>
                                                            <div><strong>Focused:</strong> Specific and not too broad in scope</div>
                                                            <div><strong>Concise:</strong> Brief and to the point</div>
                                                            <div><strong>Complex:</strong> Warrants deeper analysis, not a simple yes/no answer</div>
                                                            <div><strong>Arguable:</strong> Open to debate and requires evidence to support</div>
                                                            <div><strong>Significance:</strong> Relevant and important - addresses a meaningful issue</div>
                                                            <div><strong>Novelty:</strong> Offers new insights or perspectives on the topic</div>
                                                            <div><strong>Curiosity:</strong> Reflects genuine intellectual interest and inquiry</div>
                                                            <div><strong>Actionability:</strong> Can be investigated with available research methods and data</div>
                                                            <div><strong>Scope:</strong> Feasible to answer within master's thesis constraints</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Complete button on final stage */}
                                    {currentStage === stages.length - 1 && (
                                        <div className="mt-6 pt-6 border-t">
                                            <button
                                                onClick={handleNextStage}
                                                className="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors"
                                            >
                                                Complete the process and get the overall evaluation for downloading
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Examples and How This Works panels removed per request */}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ThesisTopicFinder />, document.getElementById('root'));
    </script>
</body>
</html>